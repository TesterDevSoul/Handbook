

有关TCP 的三次握手和四次挥手大家应该都比较熟悉，哪怕是不熟悉也都至少听说过。毕竟这是一个高频的面试题。
但是有一个问题，就是大家回答面试题的时候，只是是按着网上或者书上的内容直接背下来，并没有理解这个里面的原理。

下面，我们用通俗易懂的方式带大家来了解一下，如果是已经掌握了的小伙伴，可以再回顾一下；
如果还没有掌握的小伙伴，可以直接按照下面讲解的来理解。

在讲为什么之前先要带着大家知道什么是三次握手、四次挥手
## 概念
![](https://cdn.jsdelivr.net/gh/testeru-top/top-images/tester/202210251404604.png)
### 三次握手
在说对应概念之前，我们先来了解一个场景：
#### 场景
无论是工作还是没有工作的小伙伴，肯定都见过或经历过表白事件。那如果想要进行一次表白或者求婚，我们需要怎么做？
无论是表白、求婚都需要有对应的人，当然不只能有这个人，还需要和这个人建立一个连接。
不能说你自己把自己关在屋子里面自言自语的说，你能嫁给我吗？对方都没有听到你说的话，怎么会做出反应呢？
所以，最好是两个人面对面，才可以让对方听到到自己要说的话。约出来，面对面，就开始进行表白：

第一步：单膝跪地，手捧鲜花，说：“你能嫁给我吗？” 
>这个时候，你只是尝试着去进行表白，但是否成功还不知道，需要等对方的回应。

第二步：对方思考了一下回答：“我也想嫁给你，但是你要是把你的工资卡交给我吗？”
>这个时候，两个人之间也是建立了连接，但是这个时候你还没有回答，所以，是否同意嫁给你还没确定。

第三步：这个时候你思考了一下，说：“我可以把工资卡给你，那你就是答应了。”
这样，两个人之间对应求婚结束，关系确认。

当然这种关系都是双方是能面对面找到对方的，即都是保持双方畅通的。



![](https://cdn.jsdelivr.net/gh/testeru-top/top-images/tester/202210251424354.png)
A为Client，B为Server。
#### （1）第一次握手
##### 操作
图中绿线表示第一次握手。

进行的操作是，A请求与B建立连接。具体是A发送连接请求报文到B。这里只是**尝试的请求建立连接**，A到B的连接**是否建立成功不知道**。

形象理解为场景第一步。
#### （2）第二次握手
##### 操作
图中紫线表示第二次握手。

进行的操作是，B在收到A的请求建立连接之后，B进行响应并请求与A建立连接。具体是B接受连接后回复 ACK 报文，并为这次连接分配资源。具体是B给A返回ACK + SYN + SEQ_NO +1。

这里B给A的ACK报文就表示B同意A跟它建立连接。

SYN表示B也想尝试A建立连接，此时B到A的连接是否建立还不确定。

形象理解为场景第二步。
#### （3）第三次握手
##### 操作
图中的蓝线表示表示第三次握手。

进行的操作是，A在接收到B发送来的SYN请求之后做出ACK响应。具体就是A给B发送ACK响应。在B收到A的响应之后，此时双方的连接正式建立。
形象理解为场景第三步。


### 四次挥手

在说对应挥手概念之前，我们先来了解一个场景：
#### 场景
还是和上面场景有关，结婚了然后在一起共同生活了一段时间后，发现双方不合适，需要离婚，要离开对方，就是挥手告别。那这个时候要经历的场景是什么呢？



第一步：你需要告诉对方一个分手的理由：我们之间不合适，分手吧。我先等你的回复。
>这个时候，你只是尝试着去表达要分开的想法，但是对方还没有给你回复。



第二步：对方听到你分手的理由之后，回应到：好吧，如果你考虑清楚了，这是你的选择，那就不互相勉强了。
>这个时候，对于你而言，只是你单方面的断了和她之间的关系，对于她而言，她和你之间的关系还存在。




第三步：第一步、第二步 你和她关系断了；那在第三步的时候，对方跟你说：既然分开就彻底一些，把放在我这里你的东西拿走吧，我们彻底分开。
>此时，她和你的关系还没有断开，还要等你的回复。


第四步：当你听到她说的话之后，回应：好的，余生各自安好。
>在这个是时候，不管是你和她的关系还是她和你关系都断开了。
>此时你们两个此时真正分手了。


这样，两个人之间没有任何关系，挥手告别。

![](https://cdn.jsdelivr.net/gh/testeru-top/top-images/tester/202210251459979.png)

A为Client，B为Server。
#### （1）第一次挥手
##### 操作
进行的操作是，客户端发送FIN给服务端，尝试请求断开单方的连接。此时单方连接断开与否还不能确定，要等服务端确认，因此此时的客户端处于FIN_WAIT1状态。
形象理解为场景第一步。
#### （2）第二次挥手
##### 操作
进行的操作是，服务端收到断开请求后，服务端向客户端发送ACK回应，表示能断开了。此时只是客户端到服务端连接断开，处于半断开状态。服务端为：CLOSE_WAIT状态。
形象理解为场景第二步。
####  (3)第三次挥手
##### 操作
做的事情：服务端给客户端发送FIN请求，此时服务端处于最后一次确认状态（LAST_ACK状态）。此时还是没有断开连接，还得等待客户端回应。
形象理解为场景第三步。
#### （4）第四次挥手
##### 操作
做的事情：客户端给服务端发送ACK回应。服务端收到之后，此时连接真正断开。
形象理解为场景第四步。

## 疑问点
### 三次握手相关
###### 为什么不是两次握手？为什么要三次？
因为真正连接的建立是要双方都建立到对方的连接。
如果只有两次握手，只能保证A到B的连接建立，但是B到A连接还未确认。第三次握手主要作用就是A给B发送数据，如果没有第三次握手，A就不会发送数据，这时B的状态一直为等待，造成的现象就是浪费资源

### 四次挥手相关

###### 为什么要进行四次挥手？为什么三次不行？
因为在挥手过程中会传递相关数据。其中，ACK报文是用来的应答的，SYN报文是用来同步的。
在B收到A的FIN请求后，不会立即关闭SOCKET，会先发送一个ACK回应。
所以A需要等B的数据发送完后，B会再给A发送一个FIN请求告诉A都完事了。
所以B发送给A的两次请求不能合并，所以必须是四次挥手，不能变成三次。
